{extend name="../../base/view/common/base" /}
{block name="body"}
<div class="card-content">
	<div class="layui-row layui-col-space12">
		<div class="layui-col-md8">
			<div class="layui-row layui-col-space12">
				<div class="layui-col-md12">
					<div class="layui-card">
						<dl class="home-desc p-4">
							<dt><img src="{$params.thumb}" onerror="javascript:this.src='{__IMG__}/icon.png';this.onerror=null;"></dt>
							<dd class="h5">Hi {$params.name}ï¼Œæˆ‘æ˜¯{:get_system_config('web','admin_title')}ï¼Œæ˜¯æ‚¨å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¼™ä¼´ï¼</dd>
							<dd>{:get_system_config('web','admin_title')}æ˜¯ä¸€æ¬¾æ•æ·ç ”å‘åä½œç³»ç»Ÿå·¥å…·ï¼Œå¸®åŠ©ç ”å‘å›¢é˜Ÿé€æ˜åŒ–å·¥ä½œè¿›å±•ï¼Œæå‡åä½œæ•ˆç‡ï¼Œæ¨åŠ¨é¡¹ç›®è¿›åº¦ã€‚</dd>
						</dl>
					</div>
					<div class="layui-card">
						<div class="table-title">æœ€æ–°ä¼ä¸šå…¬å‘Š</div>
						<div style="padding:8px 12px 12px;">
							<table class="layui-table">
								<colgroup>
									<col width="80">
									<col width="90">
									<col>
									<col width="136">
								</colgroup>
								<thead>
									<tr>
										<th style="text-align:center">ç¼–å·ID</th>
										<th style="text-align:center">å…¬å‘Šåˆ†ç±»</th>
										<th>å…¬å‘Šæ ‡é¢˜</th>
										<th style="text-align:center">å‘å¸ƒæ—¶é—´</th>
									</tr>
								</thead>
								<tbody class="layui-table-body">
									{empty name="note_list"}
									<tr>
										<td colspan="4">
											<div class="layui-none">æ— æ•°æ®</div>
										</td>
									</tr>
									{/empty}
									{volist name="note_list" id="vo"}
									<tr>
										<td align="center">N{$vo.id}</td>
										<td align="center">{$vo.cate_title}</td>
										<td><a class="open-a" data-href="/home/index/note_detail/id/{$vo.id}">{$vo.title}</a></td>
										<td align="center">{$vo.create_time}</td>
									</tr>
									{/volist}
								</tbody>
							</table>
						</div>
					</div>
					<div class="layui-card">
						<div class="table-title">æˆ‘å‚ä¸çš„é¡¹ç›®</div>
						<div style="padding:8px 12px 12px;">
							<table class="layui-table">
								<colgroup>
									<col width="80">
									<col width="70">
									<col>
									<col width="80">
									<col width="60">
									<col width="180">
								</colgroup>
								<thead>
									<tr>
										<th style="text-align:center">ç¼–å·ID</th>
										<th style="text-align:center">çŠ¶æ€</th>
										<th>é¡¹ç›®ä¸»é¢˜</th>
										<th style="text-align:center">è´Ÿè´£äºº</th>
										<th style="text-align:center">ä»»åŠ¡</th>
										<th style="text-align:center">è®¡åˆ’å·¥æœŸ</th>
									</tr>
								</thead>
								<tbody class="layui-table-body">
									{empty name="$project.list"}
									<tr>
										<td colspan="6">
											<div class="layui-none">æ— æ•°æ®</div>
										</td>
									</tr>
									{/empty}
									{volist name="$project.list" id="vo"}
									<tr>
										<td align="center">M{$vo.id}</td>
										<td align="center"><span
												class="layui-badge bg-status-{$vo.status}">{$vo.status_name}</span></td>
										<td><a class="open-link" href="/project/index/view/id/{$vo.id}">{$vo.name}</a>
										</td>
										<td align="center">{$vo.director_name}</td>
										<td align="center">{$vo.tasks}</td>
										<td align="center">{$vo.plan_time}</td>
									</tr>
									{/volist}
								</tbody>
							</table>
						</div>
					</div>

					<div class="layui-card">
						<div class="table-title">æˆ‘å‚ä¸çš„ä»»åŠ¡</div>
						<div style="padding:8px 12px 12px;">
							<table class="layui-table">
								<colgroup>
									<col width="80">
									<col width="70">
									<col>
									<col width="60">
									<col width="80">
									<col width="110">
								</colgroup>
								<thead>
									<tr>
										<th style="text-align:center">ç¼–å·ID</th>
										<th style="text-align:center">çŠ¶æ€</th>
										<th>ä»»åŠ¡ä¸»é¢˜</th>
										<th style="text-align:center">ç±»å‹</th>
										<th style="text-align:center">é¢„ä¼°å·¥æ—¶</th>
										<th style="text-align:center">è®¡åˆ’å®Œæˆæ—¥æœŸ</th>
									</tr>
								</thead>
								<tbody class="layui-table-body">
									{empty name="$task.list"}
									<tr>
										<td colspan="6">
											<div class="layui-none">æ— æ•°æ®</div>
										</td>
									</tr>
									{/empty}
									{volist name="$task.list" id="vo"}
									<tr>
										<td align="center">T{$vo.id}</td>
										<td align="center"><span
												class="layui-badge bg-flow-{$vo.flow_status}">{$vo.flow_name}</span>
										</td>
										<td><span
												class="layui-badge bg-priority-{$vo.priority}">{$vo.priority_name}</span>
											<a class="open-a" data-href="/task/index/view/id/{$vo.id}">{$vo.title}</a>
										</td>
										<td align="center">{$vo.type_name}</td>
										<td align="center">{$vo.plan_hours}</td>
										<td align="center">{$vo.end_time}</td>
									</tr>
									{/volist}
								</tbody>
							</table>
						</div>
					</div>

					<div class="layui-card">
						<div class="table-title">æœ€æ–°çŸ¥è¯†æ–‡æ¡£</div>
						<div style="padding:8px 12px 12px;">
							<table class="layui-table">
								<colgroup>
									<col width="80">
									<col width="90">
									<col>
									<col width="60">
									<col width="80">
									<col width="136">
								</colgroup>
								<thead>
									<tr>
										<th style="text-align:center">ç¼–å·ID</th>
										<th style="text-align:center">æ‰€å±åˆ†ç±»</th>
										<th>çŸ¥è¯†ä¸»é¢˜</th>
										<th style="text-align:center">é˜…è§ˆæ•°</th>
										<th style="text-align:center">åˆ›å»ºå‘˜å·¥</th>
										<th style="text-align:center">åˆ›å»ºæ—¶é—´</th>
									</tr>
								</thead>
								<tbody class="layui-table-body">
									{empty name="knowledge_list"}
									<tr>
										<td colspan="5">
											<div class="layui-none">æ— æ•°æ®</div>
										</td>
									</tr>
									{/empty}
									{volist name="knowledge_list" id="vo"}
									<tr>
										<td align="center">K{$vo.id}</td>
										<td align="center">{$vo.cate_name}</td>
										<td><a class="open-link"
												href="/knowledge/index/doc_detail/kid/{$vo.id}">{$vo.title}</a></td>
										<td align="center">{$vo.views}</td>
										<td align="center">{$vo.admin_name}</td>
										<td align="center">{$vo.create_time}</td>
									</tr>
									{/volist}
								</tbody>
							</table>
						</div>
					</div>
					<div class="layui-card">
						<div id="chartView" style="width: 100%; height:300px;"></div>
					</div>
					<div class="layui-card">
						<div id="chartYear" style="width: 100%; height:240px;"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="layui-col-md4">
			<div class="layui-card dashboard-num">
				<table>
					<tbody>
						<tr>
							<td>
								<div class="num-title">äº§å“</div>
								<div class="num-num">{$count.product}</div>
							</td>
							<td>
								<div class="num-title">é¡¹ç›®</div>
								<div class="num-num">{$count.projects}</div>
							</td>
							<td>
								<div class="num-title">ä»»åŠ¡</div>
								<div class="num-num">{$count.tasks}</div>
							</td>
							<td>
								<div class="num-title">çŸ¥è¯†åº“</div>
								<div class="num-num">{$count.knowledges}</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<div class="layui-card">
				<div class="table-title">ç³»ç»Ÿä¿¡æ¯</div>
				<div class="layui-card-body">
					<table class="layui-table" lay-skin="" lay-size="sm">
						{if condition="($install == true)"}
						<tr>
							<td colspan="4" style="color: #E94335; background-color:#fafafa">
								æé†’ï¼šå‘ç°appç›®å½•ä¸‹çš„installæ–‡ä»¶å¤¹æ²¡åˆ é™¤ï¼Œä¸ºäº†ç³»ç»Ÿçš„å®‰å…¨,è¯·æ‰‹åŠ¨å»åˆ é™¤ã€‚</td>
						</tr>
						{/if}
						<tr>
							<td class="info-td">æœåŠ¡å™¨ç³»ç»Ÿ</td>
							<td>{:get_system_info('os')}</td>
							<td class="info-td">PHPç‰ˆæœ¬</td>
							<td>{:get_system_info('php')}</td>
						</tr>
						<tr>
							<td class="info-td">ä¸Šä¼ é™„ä»¶é™åˆ¶</td>
							<td>{:get_system_info('upload_max_filesize')}</td>
							<td class="info-td">æ‰§è¡Œæ—¶é—´é™åˆ¶</td>
							<td>{:get_system_info('max_execution_time')}</td>
						</tr>
						<tr>
							<td class="info-td">ThinkPHPç‰ˆæœ¬</td>
							<td>{$TP_VERSION}</td>
							<td class="info-td">Layuiç‰ˆæœ¬</td>
							<td>{:LAYUI_VERSION}</td>
						</tr>
						<tr>
							<td class="info-td">å‹¾è‚¡DEV</td>
							<td colspan="3">{:CMS_VERSION}<a class="layui-badge layui-bg-blue" style="margin-left:8px"
									href="https://blog.gougucms.com/home/book/detail/bid/7.html"
									target="_blank">å‹¾è‚¡DEVæ–‡æ¡£</a></td>
						</tr>
						<tr>
							<td class="info-td">åˆä½œè”ç³»å¾®ä¿¡å·</td>
							<td colspan="3">hdm588ï¼Œä¸šåŠ¡åˆä½œã€åŠŸèƒ½å®šåˆ¶è¯·å¤‡æ³¨</td>
						</tr>
						<tr>
							<td class="info-td">QQäº¤æµç¾¤</td>
							<td colspan="3">æœQç¾¤ï¼š24641076ï¼Œæˆ–ç‚¹å‡» <a href="https://jq.qq.com/?_wv=1027&k=pxshRv6I"
									target="_blank" rel="nofollow"><img border="0"
										src="//pub.idqqimg.com/wpa/images/group.png" alt="gougucmsäº¤æµç¾¤"
										title="gougucmsäº¤æµç¾¤" style="vertical-align:middle"></a></td>
						</tr>
						<tr>
							<td class="info-td">åŒç³»åˆ—å¼€æºè½¯ä»¶</td>
							<td colspan="3"><a class="layui-badge layui-bg-blue" style="margin-right:8px"
									href="https://gitee.com/gouguopen/gougucms" target="_blank">å‹¾è‚¡CMS</a><a
									class="layui-badge layui-bg-blue" style="margin-right:8px"
									href="https://gitee.com/gouguopen/blog" target="_blank">å‹¾è‚¡BLOG</a><a
									class="layui-badge layui-bg-blue" style="margin-right:8px"
									href="https://gitee.com/gouguopen/office" target="_blank">å‹¾è‚¡OA</a><a
									class="layui-badge layui-bg-blue"
									href="https://gitee.com/gouguopen/guoguadmin" target="_blank">å‹¾è‚¡Admin</a></td>
						</tr>
						<tr>
							<td class="info-td">ğŸ—ğŸ—ğŸ—<br />ç»™ä½œè€…åŠ é¸¡è…¿<br />ğŸ—ğŸ—ğŸ—</td>
							<td colspan="3">
								<img src="https://www.gougucms.com/static/home/images/zfb.png" data-event="pay"
									style="width:50%; max-width:100%; cursor:pointer;" align=center /><img
									src="https://www.gougucms.com/static/home/images/wx.png" data-event="pay"
									style="width:50%; max-width:100%; cursor:pointer;" align=center />
							</td>
						</tr>
					</table>
					<script>
						$('body').on('click', '[data-event="pay"]', function () {
							var src = $(this).attr('src');
							layer.open({
								type: 1,
								title: 'æ„Ÿè°¢æ‚¨ç»™ä½œè€…åŠ é¸¡è…¿ğŸ—ğŸ—',
								content: '<img src="' + src + '" style="width:100%" align=center />',
							});
						})
					</script>
				</div>
			</div>

			<div class="layui-card dashboard-total">
				<div class="table-title mb-3">æˆ‘çš„å·¥ä½œæƒ…å†µ</div>
				<div class="layui-card dashboard-num">
					<table>
						<tbody>
							<tr>
								<td>
									<div class="num-title">å‚ä¸é¡¹ç›®</div>
									<div class="num-num">{$project.count}</div>
								</td>
								<td>
									<div class="num-title">å·²å®Œæˆ</div>
									<div class="num-num">{$project.count_ok}</div>
								</td>
								<td>
									<div class="num-title">æœªå®Œæˆ</div>
									<div class="num-num">{$project.count_no}</div>
								</td>
								<td>
									<div class="num-title">å®Œæˆç‡</div>
									<div class="num-num">{$project.count_lv}%</div>
									<div class="badge"><span class="layui-bg-blue">å½±å“åŠ›</span></div>
								</td>
							</tr>
							<tr>
								<td>
									<div class="num-title">å‚ä¸ä»»åŠ¡</div>
									<div class="num-num">{$task.count}</div>
								</td>
								<td>
									<div class="num-title">å·²å®Œæˆ</div>
									<div class="num-num">{$task.count_ok}</div>
								</td>
								<td>
									<div class="num-title">æœªå®Œæˆ</div>
									<div class="num-num">{$task.count_no}</div>
								</td>
								<td>
									<div class="num-title">å®Œæˆç‡</div>
									<div class="num-num">{$task.count_lv}%</div>
									<div class="badge"><span class="layui-bg-blue">æ‹¼æ•ˆç‡</span></div>
								</td>
							</tr>
							<tr>
								<td>
									<div class="num-title">å·¥ä½œè®°å½•</div>
									<div class="num-num">{$work.count}</div>
								</td>
								<td>
									<div class="num-title">æ€»å·¥æ—¶</div>
									<div class="num-num">{$work.hours}</div>
								</td>
								<td>
									<div class="num-title">ä»»åŠ¡å»¶æœŸ</div>
									<div class="num-num">{$task.delay}</div>
								</td>
								<td>
									<div class="num-title">å»¶æœŸç‡</div>
									<div class="num-num">{$task.delay_lv}%</div>
									<div class="badge"><span class="layui-bg-blue">å‹¤å¥‹åº¦</span></div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div class="layui-card">
				<div class="table-title">æœ€æ´»è·ƒå‘˜å·¥<span
						style="color:#999; font-size:14px; font-weight:400; margin-left:5px">æœ€è¿‘30å¤©å‰åçš„æ´»è·ƒåº¦</span></div>
				<div class="layui-card-body">
					<div id="logChart" style="width: 100%; height:268px;"></div>
				</div>
			</div>
			<div class="layui-card">
				<div class="table-title">å‘˜å·¥æœ€æ–°åŠ¨æ€</div>
				<div class="layui-card-body dashboard-logs">
					<ul class="layui-timeline" id="logs"></ul>
				</div>
			</div>
		</div>
	</div>
	{/block}
	<!-- è„šæœ¬ -->
	{block name="script"}
	<script src="https://cdn.staticfile.org/echarts/5.3.0/echarts.min.js"></script>
	<script>
		const moduleInit = ['tool','gouguEdit','gouguComment','gouguSchedule','employeepicker'];
		function gouguInit() {	
			get_logs();
			get_view_data();
		}

		function setHour(num) {
			var str = num + ':00';
			if (num < 10) {
				str = '0' + num + ':00';
			}
			return str;
		}
		var archiveCalendar = {};
		function getRange() {
			let today = new Date();
			let tYear = today.getFullYear();
			let tMonth = today.getMonth() + 1;
			let tDate = today.getDate();
			let dateFirst = tYear + "-" + tMonth + "-" + tDate;
			let datelast = (tYear - 1) + "-" + tMonth + "-" + tDate;
			let dataRange = [];
			dataRange.push(dateFirst);
			dataRange.push(datelast);
			return dataRange;
		}

		function getDay() {
			var today = new Date();
			var dayArray = [];
			for (var i = 0; i < 366; i++) {
				var targetday_milliseconds = today.getTime() - 1000 * 60 * 60 * 24 * i;
				var date = new Date(targetday_milliseconds);
				dayArray.push(retunDay(date));
			}
			return dayArray;
		}

		function retunDay(day) {
			var tYear = day.getFullYear();
			var tMonth = day.getMonth();
			var tDate = day.getDate();
			tMonth = tMonth + 1;
			if (tMonth.toString().length == 1) {
				tMonth = "0" + tMonth;
			}
			if (tDate.toString().length == 1) {
				tDate = "0" + tDate;
			}
			var dateStr = tYear + "-" + tMonth + "-" + tDate;
			var dateArray = [];
			dateArray.push(dateStr);
			if (archiveCalendar[dateStr]) {
				dateArray.push(archiveCalendar[dateStr]);
			}
			else {
				dateArray.push(0);
			}
			return dateArray;
		}

		var chartView = echarts.init(document.getElementById('chartView'));
		var chartYear = echarts.init(document.getElementById('chartYear'));
		var logChart = echarts.init(document.getElementById('logChart'));
		function get_view_data() {
			$.ajax({
				url: "/home/index/get_view_data",
				type: 'get',
				data: {},
				success: function (e) {
					if (e.code == 0) {
						var data_first = e.data.data_first;
						var data_second = e.data.data_second;
						archiveCalendar = e.data.data_three;
						var data_logs = e.data.data_logs;
						var myDate = new Date();
						var nowHour = myDate.getHours(); //è·å–å½“å‰å°æ—¶æ•°(0-23)
						var xData = [];
						var yData1 = [];
						var yData2 = [];
						var logItem = [];
						$.each(data_first, function (key, value) {
							if (key <= nowHour) {
								yData1.push(value);
							}
						});

						$.each(data_second, function (key, value) {
							xData.push(setHour(key));
							yData2.push(value);
						});

						$.each(data_logs, function (key, value) {
							let item = {
								value: value.count,
								name: value.name
							};
							logItem.push(item);
						});

						let opsA = {
							title: {
								top: '12px',
								text: 'ä»Šæ—¥ä¸æ˜¨æ—¥å‘˜å·¥æ´»è·ƒåº¦',
								left: '8px',
								textStyle: {
									fontSize: '18',
									color: '#333',
								}
							},
							color: ["#1AAD19", "#1890FF"],
							grid: {
								left: '16px',
								right: '30px',
								bottom: '12px',
								top: '60px',
								containLabel: true
							},
							tooltip: {
								trigger: 'axis',
								axisPointer: {
									type: 'cross',
									crossStyle: {
										color: '#999'
									}
								}
							},
							toolbox: {
								show: true,
							},
							legend: {
								data: ["ä»Šæ—¥", "æ˜¨æ—¥"],
								top: '16px',
							},
							xAxis: [{
								type: "category",
								boundaryGap: !1,
								data: xData,
								axisLine: {
									lineStyle: {
										color: '#999999',
										width: 1,
									}
								},
							}],
							yAxis: [{
								type: "value",
								axisLine: {
									show: true,
									lineStyle: {
										color: '#999999',
										width: 1,
									}
								},
							}],
							series: [{
								name: "ä»Šæ—¥",
								type: "line",
								smooth: !0,
								itemStyle: {
									normal: {
										areaStyle: {
											type: "default",
											opacity: 0.2
										}
									}
								},
								data: yData1
							}, {
								name: "æ˜¨æ—¥",
								type: "line",
								smooth: !0,
								itemStyle: {
									normal: {
										areaStyle: {
											type: "default",
											opacity: 0.2
										}
									}
								},
								data: yData2
							}]
						}
						chartView.setOption(opsA);

						let opsB = {
							title: {
								top: '12px',
								text: 'è¿‘ä¸€å¹´å‘˜å·¥æ´»è·ƒåº¦',
								left: '8px',
								textStyle: {
									fontSize: '18',
									color: '#333',
								}
							},
							tooltip: {
								padding: 6,
								formatter: function (obj) {
									var value = obj.value;
									return '<div style="font-size: 12px;">' + value[0] + 'å‘˜å·¥æ´»è·ƒåº¦ï¼š' + value[1] + '</div>';
								}
							},
							visualMap: {
								min: 0,
								max: 300,
								show: false,
								inRange: {
									color: ['#fafafa', '#1AAD19']
								}
							},
							calendar: {
								top: 72,
								left: 52,
								right: 20,
								range: getRange(),
								cellSize: ['auto', 21],
								splitLine: {
									lineStyle: {
										color: '#aaa',
										type: 'dashed'
									}
								},
								itemStyle: {
									borderWidth: 0.5
								},
								yearLabel: { show: false },
								monthLabel: {
									nameMap: 'cn',
									fontSize: 12
								},
								dayLabel: {
									show: true,
									formatter: '{start}  1st',
									fontWeight: 'lighter',
									nameMap: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'],
									fontSize: 12
								}
							},
							series: [{
								type: 'heatmap',
								coordinateSystem: 'calendar',
								calendarIndex: 0,
								data: getDay()
							}]
						};
						chartYear.setOption(opsB);


						let optC = {
							tooltip: {
								trigger: 'item',
								formatter: '{a} <br/>{b} :{d}%'
							},
							legend: {
								top: '1%',
								left: 'center'
							},
							series: [
								{
									name: 'æ´»è·ƒåº¦',
									type: 'pie',
									radius: '50%',
									center: ['50%', '60%'],
									data: logItem,
									emphasis: {
										itemStyle: {
											shadowBlur: 10,
											shadowOffsetX: 0,
											shadowColor: 'rgba(0, 0, 0, 0.5)'
										}
									}
								}
							]
						};
						logChart.setOption(optC);
					}
				}
			})
		}

		window.onresize = function () {
			chartView.resize();
			chartYear.resize();
			logChart.resize();
		}

		//è·å–å·¥ä½œè®°å½•
		function get_logs() {
			$.ajax({
				url: "/home/index/log_list",
				type: 'get',
				data: {
					page: 1,
					limit: 15
				},
				success: function (e) {
					if (e.code == 0) {
						var html = '';
						$.each(e.data, function (key, value) {
							html += `<li class="layui-timeline-item">
								<i class="layui-icon layui-timeline-axis">î˜¿</i>
								<div class="layui-timeline-content layui-text">
									 <div class="layui-timeline-title"><span title="${value.id}">${value.times}</span>ï¼Œ${value.content}</div>
								</div>
							</li>`;
						});
						$('#logs').html(html);
					}
				}
			})
		}
	</script>
	<!-- /è„šæœ¬ -->
	{/block}